# Causal Metamorphic Relation Generation
This repository contains the code to perform the empirical evaluation
in our paper on Causal Metamorphic Testing.

## DAG generation
All of the code for generating random DAGs is found in `dags/dag_generation.py`.
A DAG can be generated by calling the `generate_dag` method with the desired
parameter settings (number of nodes, probability of an arbitrary edge,
probability of conditional, seed). Note that, the `p_conditional` parameter will
not affect the structure of the graph, it will attach a comment to any 
generated DOT file.

Example:
`dag = generate_dag(10, 0.5, 0.25)`

You can find a series of DAG-related helper methods in `dags/dag_utils.py`.

## Program generation
All of the code for generating synthetic programs is found in 
`programs/program_generation.py`. A program can be generated from a given
DAG by calling the method `generate_program` and passing it the necessary
parameters (a DAG, a probability of making non-input nodes conditional, an
output directory, and a name for the program). This will produce a python file
with the specified name at the specified directory with the specified amount of 
conditional behaviour. Note that our experiment ensures
the same conditional parameter is used for program and DAG generation.

Example:
`generate_program(dag, 0.25, "../prog_directory", "program")`

Although not used in the evaluation, `programs/program_testing.py` contains
code that can be used to check whether the implied metamorphic relations pass.
As shown in the paper, for this form of synthetic program, this should be the 
case provided there is no conditional behaviour i.e. non-injective relations, and
the specification is perfect (which it is, by construction).

## Metamorphic relation generation
The code for generating metamorphic relations can be found in 
`metamorphic_relations/metamorphic_relation_generation.py` and the
metamorphic relation object can be found in
`metamorphic_relations/metamorphic_relation.py`. Given a DAG, the
implied metamorphic relations can be constructed by calling 
`generate_metamorphic_relations`, passing this method the target DAG.

Example:
`generate_metamorphic_relations(dag)`

The metamorphic relation class contains the functionality for 
generating and executing tests for the specified relation. A subclass
is also defined for `ShouldCause` and `ShouldNotCause` relations, specifically,
that also implement a test oracle. This is automatically applied when the
metamorphic relation is executed and checks for inequality in at least on test
in the case of `ShouldCause`, and inequality in all tests in the case of
`ShouldNotCause`.

## Mutation Configurations
In this repository, we include the functionality for specifying a series of
applicable mutants that alter the casual structure of the program-under-test,
as described in the paper. The code for this can be found in 
`mutation_testing/mutation_config_generation.py`. This contains the method
`generate_causal_mutation_config`, which takes a DAG and a target directory as 
arguments, and produces a TOML file that is compatible with the Cosmic Ray
mutation testing framework. This specifies a series of mutation operations
that add or remove causes from the program-under-test.

## Generating an experiment
To generate an experiment, run `evaluate.py` with the specific parameters,
including: `-nd` (the number of dags), `-nn` (the number of nodes per dag), 
`-pe` (the probability of an arbitrary edge), `-pc` (the probability of making 
an arbitrary node conditional), `-en` (path to save the experiment at), `-s`
(seed), `-t` (a specific task, `gen` for generation).

This will produce a directory containing a series of seed directories (one for
each DAG configuration). Within each of these directories, there is a program and
a directory called dags. This contains a directory for each version of the DAG,
corresponding to the different levels of misspecification. Each of these 
directories contains a dot file describing the DAG and a mutation config.

For compatability with our experiment scripts, we recommend setting `-en` to
`evaluation/YOUR_EXPERIMENT_NAME`. This is because our scripts assume all
configuration directories are in a directory named `evaluation`.

## Scripts
There are also a series of bash scripts at the top level of the directory.
These are used to run the experiments in batches on an HPC. However, the 
`run_dags.sh` script can be executed to execute a specific seed directory,
generating and executing a specified number of tests. This script takes two
positional arguments:
1. The path to the seed directory.
2. The desired number of tests.

Example:
`bash run_dags.sh evaluation/nn_10_pe_25_pc_25/seed_18248 10`

## Requirements
Create a new virtual environment using Python 3.9 and pip install the following
libraries:
- git+https://github.com/AndrewC19/cosmic-ray.git@0779a3908b24016425cc828e2c868d5c64739afd
- mccabe
- networkx
- numpy
- pandas
- tomlkit
- pydot

Then run `pip install -e .`.